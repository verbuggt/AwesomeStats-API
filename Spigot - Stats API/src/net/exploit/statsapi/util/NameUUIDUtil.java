package net.exploit.statsapi.util;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.UUID;

import org.bukkit.Bukkit;

import net.exploit.statsapi.main.StatsAPI;
import net.exploit.statsapi.mysql.MySQL;

public class NameUUIDUtil {

    private static MySQL mysql = StatsAPI.getApi().getMySQL();
    private static HashMap<String, UUID> uuid_cache = new HashMap<>();
    private static HashMap<UUID, String> name_cache = new HashMap<>();

    public static String getNameByUUID(String uuid) {
        return getNameByUUID(UUID.fromString(uuid));
    }

    public static String getNameByUUID(UUID uuid) {
        if (name_cache.containsKey(uuid))
            return name_cache.get(uuid);
        ResultSet rs;
        try {
            rs = mysql.query("SELECT name FROM users WHERE uuid='" + uuid.toString() + "'");
            if (rs != null && rs.next())
                return cache(rs.getString("name"), uuid);
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    public static UUID getUUIDByName(String name) {
        if (uuid_cache.containsKey(name))
            return uuid_cache.get(name);
        ResultSet rs;
        try {
            rs = mysql.query("SELECT uuid FROM users WHERE name='" + name + "'");
            if (rs != null && rs.next())
                return cache(UUID.fromString(rs.getString("uuid")), name);
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }

    private static String cache(String name, UUID uuid) {
        if (!NameUUIDUtil.name_cache.containsKey(uuid))
            NameUUIDUtil.name_cache.put(uuid, name);
        return name;
    }

    private static UUID cache(UUID uuid, String name) {
        if (!NameUUIDUtil.uuid_cache.containsKey(name))
            NameUUIDUtil.uuid_cache.put(name, uuid);
        return uuid;
    }

    public static boolean exists(UUID uuid) {
        if (mysql.isConnected())
            try {
                ResultSet rs = mysql.query("SELECT name FROM users WHERE uuid='" + uuid + "';");
                if (rs.next())
                    return true;
            } catch (SQLException e) {
                e.printStackTrace();
            }
        else
            Bukkit.getLogger().warning("Could not check if user '" + (uuid == null ? "null" : uuid.toString()) + "' exists.");
        return false;
    }
}

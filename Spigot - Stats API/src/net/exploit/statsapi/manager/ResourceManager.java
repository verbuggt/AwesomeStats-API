package net.exploit.statsapi.manager;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.regex.Pattern;

import org.bukkit.Bukkit;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.configuration.file.YamlConfiguration;

public abstract class ResourceManager {

    public FileConfiguration cfg;
    protected File file;

    private String filename;
    private String datafolder;

    public ResourceManager(String filename, String datafolder) {
        String[] args = filename.split(Pattern.quote("."));
        this.filename = (args.length > 1 && args[args.length - 1].equals("yml")) ? filename : filename + ".yml";
        this.datafolder = datafolder;

        loadData();
    }

    private void loadData() {
        this.file = new File("plugins/" + datafolder + "/" + filename);
        if (!this.file.exists() || this.file.length() == 0) {
            Bukkit.getLogger().info("Creating Parent Folders...");
            try {
                if (this.file.getParentFile().mkdirs())
                    this.file.createNewFile();
            } catch (IOException e) {
                e.printStackTrace();
            }
            try {
                Bukkit.getLogger().info("Reading Resource...");
                InputStream in = this.getClass().getResourceAsStream("/" + this.filename);
                try (FileOutputStream out = new FileOutputStream(this.file)) {
                    // TODO fix Zip-Format-Exception
                    byte[] buffer = new byte[1024];
                    int bytesRead;
                    Bukkit.getLogger().info("Copying Resource-Stream to File...");
                    while ((bytesRead = in.read(buffer)) != -1) {
                        out.write(buffer, 0, bytesRead);
                    }
                    Bukkit.getLogger().info("Done.");
                    in.close();
                }
            } catch (IOException e) {
                Bukkit.getLogger().warning("NOTE: Jar-File may be inaccessible if it's already loaded, consider a >restart< if problems occur.");
                Bukkit.getLogger().info("An error occurred while trying to copy a Resource-File");
                Bukkit.getLogger().info("Error-Message: " + e.getMessage());
                e.printStackTrace();
            }
        }
        this.cfg = YamlConfiguration.loadConfiguration(this.file);
    }

    public ResourceManager(FileConfiguration cfg) {
        this.file = null;
        this.cfg = cfg;
    }

    public File getFile() {
        return file;
    }

    public FileConfiguration getConfig() {
        return cfg;
    }

    public void save() {
        try {
            this.cfg.save(this.file);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public void reload() {
        loadData();
    }

}
